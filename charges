import time
import board
import busio
from adafruit_ina219 import INA219
from pijuice import PiJuice

# ANSI escape codes for colors
BLUE = "\033[94m"
CYAN = "\033[96m"
PURPLE = "\033[95m"
BOLD = "\033[1m"
RESET = "\033[0m"

# Initialize I2C bus
i2c = busio.I2C(board.SCL, board.SDA)

# Initialize INA219 current sensor
ina219 = INA219(i2c)

# Initialize PiJuice
pijuice = PiJuice(1, 0x14)  # I2C address of PiJuice

# Setup INA219 for correct scaling
ina219.configure()

# Function to check if solar power is present and read input voltage/current
def get_solar_input():
    status = pijuice.status.GetStatus()
    io_voltage = pijuice.status.GetIoVoltage()
    io_current = pijuice.status.GetIoCurrent()

    if io_voltage["error"] or io_current["error"]:
        print(f"{BOLD}{PURPLE}Error reading solar input!{RESET}")
        return None, None
    
    solar_voltage = io_voltage["data"] / 1000.0  # Convert mV to V
    solar_current = io_current["data"]  # Already in mA

    print(f"{BLUE}Solar Voltage (Input Voltage): {solar_voltage} V{RESET}")
    print(f"{CYAN}Solar Current (Input Current): {solar_current} mA{RESET}")

    return solar_voltage, solar_current

# Function to get battery charge status from PiJuice
def get_battery_charge():
    battery_status = pijuice.status.GetChargeLevel()
    battery_voltage = pijuice.status.GetBatteryVoltage()

    if battery_status["error"] or battery_voltage["error"]:
        print(f"{BOLD}{PURPLE}Error reading battery status!{RESET}")
        return None, None
    
    battery_percentage = battery_status["data"]
    battery_voltage = battery_voltage["data"] / 1000.0  # Convert mV to V
    print(f"{BLUE}Battery Voltage: {battery_voltage} V{RESET}")
    print(f"{CYAN}Battery Charge: {battery_percentage} %{RESET}")
    return battery_voltage, battery_percentage

# Function to measure load output
def get_load_output():
    load_voltage = ina219.voltage()
    load_current = ina219.current()
    load_power = load_voltage * (load_current / 1000)  # in Watts
    print(f"{BLUE}Load Voltage: {load_voltage} V{RESET}")
    print(f"{CYAN}Load Current: {load_current} mA{RESET}")
    print(f"{PURPLE}Load Power: {load_power} W{RESET}")
    return load_voltage, load_current, load_power

# Main monitoring loop
while True:
    print(f"\n{BOLD}{PURPLE}--- Power System Status ---{RESET
